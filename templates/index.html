<!DOCTYPE html>
<html lang="{{ session.get('language', 'ko') }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ _('Whisper 음성-텍스트 변환기') }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        padding-top: 2rem;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 800px;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover {
        border-color: #0d6efd;
        background-color: #f1f8ff;
      }
      .upload-area.highlight {
        border-color: #0d6efd;
        background-color: #e6f2ff;
      }
      #result-container {
        display: none;
        margin-top: 2rem;
      }
      #loading {
        display: none;
        text-align: center;
        margin-top: 1rem;
      }
      .copy-btn {
        cursor: pointer;
      }
      #transcription-result {
        white-space: pre-wrap; /* 행 바꿈 유지 */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        max-height: 500px;
        overflow-y: auto;
      }

      /* 오디오 플레이어 스타일 */
      .audio-player-container {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .audio-player {
        width: 100%;
      }

      /* 세그먼트 스타일 */
      .segment {
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
        border-left: 4px solid transparent;
        cursor: pointer;
        position: relative;
      }

      .segment:hover {
        background-color: #f8f9fa;
        border-left: 4px solid #e9ecef;
      }

      .segment.active {
        background-color: #fff8e1;
        box-shadow: 0 0 0 2px #ffd54f;
        border-left: 4px solid #ffc107;
        padding-left: 0.75rem;
        font-weight: 500;
      }

      /* 현재 재생 중인 세그먼트 표시 애니메이션 */
      @keyframes pulse-border {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        }
        70% {
          box-shadow: 0 0 0 6px rgba(255, 193, 7, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
        }
      }

      .segment.active {
        animation: pulse-border 2s infinite;
      }

      .segment-text {
        margin-top: 0.5rem;
      }

      .time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-left: 0.5rem;
        font-family: monospace;
      }

      /* 언어 선택 스타일 */
      .language-select {
        margin-bottom: 1rem;
      }

      /* 프로그레스바 스타일 */
      .progress {
        height: 20px;
        margin-top: 15px;
        margin-bottom: 10px;
      }

      /* 세션 목록 스타일 */
      .session-list {
        margin-top: 2rem;
      }

      .session-card {
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
      }

      .session-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      .session-card.active {
        border-color: #0d6efd;
        background-color: #f0f7ff;
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
      }

      .session-card .card-body {
        padding: 1rem;
      }

      .session-card .card-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .session-card .card-text {
        font-size: 0.85rem;
        color: #6c757d;
      }

      .session-card .language-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      .tab-content {
        margin-top: 1rem;
      }

      /* UI 언어 선택 스타일 */
      .ui-language-selector {
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .ui-language-selector .dropdown-menu {
        min-width: 100px;
      }

      .ui-language-selector .dropdown-item {
        padding: 0.25rem 1rem;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .ui-language-selector {
          position: relative;
          top: 0;
          right: 0;
          margin-bottom: 1rem;
          text-align: right;
        }
      }

      /* 세그먼트 편집 스타일 */
      .segment-edit-form {
        margin-top: 0.5rem;
      }

      .segment-edit-textarea {
        min-height: 60px;
        font-size: 0.95rem;
      }

      .edit-segment-btn {
        opacity: 0.3;
        transition: opacity 0.2s;
      }

      .segment:hover .edit-segment-btn {
        opacity: 1;
      }

      /* 토스트 컨테이너 스타일 */
      .toast-container {
        z-index: 1050;
      }

      /* 세션 삭제 버튼 스타일 */
      .delete-session-btn {
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .delete-session-btn:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- UI 언어 선택기 -->
      <div class="ui-language-selector dropdown">
        <button
          class="btn btn-sm btn-outline-secondary dropdown-toggle"
          type="button"
          id="languageDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-globe"></i> {{ ui_languages[session.get('language',
          'ko')] }}
        </button>
        <ul
          class="dropdown-menu dropdown-menu-end"
          aria-labelledby="languageDropdown"
        >
          {% for code, name in ui_languages.items() %}
          <li>
            <a
              class="dropdown-item {% if session.get('language') == code %}active{% endif %}"
              href="{{ url_for('set_language', language=code) }}"
              >{{ name }}</a
            >
          </li>
          {% endfor %}
        </ul>
      </div>

      <h1 class="text-center mb-4">{{ _('Whisper 음성-텍스트 변환기') }}</h1>

      <!-- 탭 메뉴 -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="new-tab"
            data-bs-toggle="tab"
            data-bs-target="#new-content"
            type="button"
            role="tab"
            aria-controls="new-content"
            aria-selected="true"
          >
            <i class="bi bi-plus-circle"></i> {{ _('새 변환') }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="history-tab"
            data-bs-toggle="tab"
            data-bs-target="#history-content"
            type="button"
            role="tab"
            aria-controls="history-content"
            aria-selected="false"
          >
            <i class="bi bi-clock-history"></i> {{ _('이전 기록') }}
          </button>
        </li>
      </ul>

      <!-- 탭 내용 -->
      <div class="tab-content" id="myTabContent">
        <!-- 새 변환 탭 -->
        <div
          class="tab-pane fade show active"
          id="new-content"
          role="tabpanel"
          aria-labelledby="new-tab"
        >
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">{{ _('음성 파일 업로드') }}</h5>
              <p class="card-text">
                {{ _('MP3, WAV, OGG, M4A, FLAC 형식의 오디오 파일을
                업로드하세요.') }}
              </p>
              <p class="text-info">
                <i class="bi bi-info-circle"></i> {{ _('선택한 언어로 음성을
                텍스트로 변환합니다. 문장 사이에 자동으로 행 바꿈이
                추가됩니다.') }}
              </p>

              <div class="language-select">
                <label for="language-select" class="form-label"
                  >{{ _('언어 선택:') }}</label
                >
                <select class="form-select" id="language-select">
                  {% for code, name in languages.items() %}
                  <option value="{{ code }}">{{ name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div id="upload-area" class="upload-area">
                <div id="upload-prompt">
                  <i class="bi bi-cloud-arrow-up fs-1"></i>
                  <p>
                    {{ _('파일을 여기에 끌어다 놓거나 클릭하여 선택하세요') }}
                  </p>
                  <button id="select-file-btn" class="btn btn-primary">
                    {{ _('파일 선택') }}
                  </button>
                </div>
                <input
                  type="file"
                  id="file-input"
                  accept=".mp3,.wav,.ogg,.m4a,.flac"
                  style="display: none"
                />
              </div>

              <div id="loading" class="mt-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">{{ _('로딩 중...') }}</span>
                </div>
                <p class="mt-2">
                  {{ _('음성을 텍스트로 변환 중입니다. 잠시만 기다려주세요...')
                  }}
                </p>
                <div class="progress">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
                <p class="status-text mt-2"></p>
                <p
                  class="elapsed-time mt-1"
                  style="font-size: 0.9em; color: #6c757d"
                ></p>
              </div>
            </div>
          </div>
        </div>

        <!-- 이전 기록 탭 -->
        <div
          class="tab-pane fade"
          id="history-content"
          role="tabpanel"
          aria-labelledby="history-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">{{ _('이전 변환 기록') }}</h5>
              <p class="card-text">
                {{ _('이전에 변환한 파일 목록입니다. 클릭하여 결과를 확인할 수
                있습니다.') }}
              </p>

              <div class="session-list">
                {% if sessions %}
                <div class="row">
                  {% for session in sessions %}
                  <div class="col-md-6">
                    <div
                      class="card session-card"
                      data-session-id="{{ session.id }}"
                    >
                      <div class="card-body">
                        <h5 class="card-title">{{ session.filename }}</h5>
                        <p class="card-text">
                          <small>{{ session.created_at }}</small>
                          <span class="badge bg-info language-badge float-end"
                            >{{ languages[session.language] }}</span
                          >
                        </p>
                        <div class="d-flex justify-content-end mt-2">
                          <button
                            class="btn btn-sm btn-outline-danger delete-session-btn"
                            data-session-id="{{ session.id }}"
                            data-session-name="{{ session.filename }}"
                            title="{{ _('이 세션 삭제') }}"
                          >
                            <i class="bi bi-trash"></i> {{ _('삭제') }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                  {{ _('아직 변환 기록이 없습니다. 새 파일을 변환해보세요.') }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="result-container" class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">{{ _('변환 결과') }}</h5>
            <button id="copy-btn" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-clipboard"></i> {{ _('복사') }}
            </button>
          </div>

          <!-- 오디오 플레이어 추가 -->
          <div
            id="audio-player-container"
            class="audio-player-container"
            style="display: none"
          >
            <audio id="audio-player" class="audio-player" controls>
              <source src="" type="audio/mpeg" />
              {{ _('브라우저가 오디오 재생을 지원하지 않습니다.') }}
            </audio>
          </div>

          <div id="transcription-result" class="p-3 bg-light rounded"></div>
        </div>
      </div>
    </div>

    <!-- 세션 삭제 확인 모달 -->
    <div
      class="modal fade"
      id="deleteSessionModal"
      tabindex="-1"
      aria-labelledby="deleteSessionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteSessionModalLabel">
              {{ _('세션 삭제 확인') }}
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>{{ _('다음 세션을 삭제하시겠습니까?') }}</p>
            <p id="delete-session-name" class="fw-bold"></p>
            <p class="text-danger">{{ _('이 작업은 되돌릴 수 없습니다.') }}</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              {{ _('취소') }}
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirm-delete-btn"
            >
              {{ _('삭제') }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const uploadArea = document.getElementById("upload-area");
        const fileInput = document.getElementById("file-input");
        const selectFileBtn = document.getElementById("select-file-btn");
        const loading = document.getElementById("loading");
        const resultContainer = document.getElementById("result-container");
        const transcriptionResult = document.getElementById(
          "transcription-result"
        );
        const copyBtn = document.getElementById("copy-btn");
        const languageSelect = document.getElementById("language-select");

        const progressBar = loading.querySelector(".progress");
        const progressBarInner = progressBar.querySelector(".progress-bar");
        const statusText = loading.querySelector(".status-text");
        const elapsedTimeText = loading.querySelector(".elapsed-time");

        let currentTaskId = null;
        let statusCheckInterval = null;
        let segments = []; // 세그먼트 정보 저장
        let activeSegmentIndex = -1; // 현재 활성화된 세그먼트 인덱스
        let deleteSessionId = null; // 삭제할 세션 ID

        // 세션 카드 클릭 이벤트 처리
        document.querySelectorAll(".session-card").forEach((card) => {
          card.addEventListener("click", function () {
            const sessionId = this.getAttribute("data-session-id");

            // 모든 세션 카드에서 active 클래스 제거
            document.querySelectorAll(".session-card").forEach((c) => {
              c.classList.remove("active");
            });

            // 클릭한 카드에 active 클래스 추가
            this.classList.add("active");

            loadSession(sessionId);
          });
        });

        // 세션 로드 함수
        function loadSession(sessionId) {
          // 로딩 표시
          loading.style.display = "block";
          resultContainer.style.display = "none";

          // 세션 정보 가져오기
          fetch(`/status/${sessionId}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // 세션 데이터 표시
                loading.style.display = "none";
                resultContainer.style.display = "block";

                // 세그먼트 정보 저장
                if (data.segments && data.segments.length > 0) {
                  segments = data.segments;
                  console.log("세그먼트 데이터 로드됨:", segments.length);
                } else {
                  console.log(
                    "세그먼트 데이터가 없습니다. 텍스트에서 세그먼트 생성 시도"
                  );
                  // 세그먼트 데이터가 없는 경우 텍스트에서 세그먼트 생성
                  if (data.transcription) {
                    segments = createSegmentsFromText(data.transcription);
                    console.log("텍스트에서 세그먼트 생성됨:", segments.length);
                  }
                }

                // 오디오 플레이어 설정
                if (data.audio_path) {
                  setupAudioPlayer(data.audio_path);
                }

                // 변환 결과 표시 (세그먼트 데이터 전달)
                displayTranscriptionResult(data.transcription);

                // 탭 전환
                const newTabEl = document.querySelector("#new-tab");
                const tab = new bootstrap.Tab(newTabEl);
                tab.show();
              } else {
                loading.style.display = "none";
                alert(
                  "{{ _('오류:') }} " +
                    (data.error || "{{ _('세션을 불러올 수 없습니다.') }}")
                );
              }
            })
            .catch((error) => {
              loading.style.display = "none";
              alert(
                "{{ _('세션 로드 중 오류가 발생했습니다:') }} " + error.message
              );
            });
        }

        // 텍스트에서 세그먼트 생성 함수
        function createSegmentsFromText(text) {
          const lines = text.split("\n").filter((line) => line.trim() !== "");
          const segments = [];

          let startTime = 0;

          // 텍스트 길이에 따라 세그먼트 길이 조정
          lines.forEach((line, index) => {
            // 텍스트 길이에 비례하여 지속 시간 계산 (최소 2초, 최대 5초)
            const wordCount = line.split(/\s+/).length;
            const duration = Math.min(Math.max(wordCount * 0.5, 2), 5);

            // 세그먼트 간 약간의 간격 추가 (0.2초)
            // 이렇게 하면 세그먼트 간 전환이 더 자연스러워짐
            const endTime = startTime + duration;
            segments.push({
              text: line,
              start: startTime,
              end: endTime - 0.2, // 세그먼트 끝에서 약간의 시간 제거
            });
            startTime = endTime;
          });

          console.log("생성된 세그먼트:", segments);
          return segments;
        }

        selectFileBtn.addEventListener("click", function (e) {
          e.preventDefault();
          fileInput.click();
        });

        uploadArea.addEventListener("click", function (e) {
          if (
            e.target === uploadArea ||
            e.target.parentElement === uploadArea
          ) {
            fileInput.click();
          }
        });

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          uploadArea.classList.add("highlight");
        }

        function unhighlight() {
          uploadArea.classList.remove("highlight");
        }

        uploadArea.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length) {
            handleFiles(files[0]);
          }
        }

        fileInput.addEventListener("change", function () {
          if (this.files.length) {
            handleFiles(this.files[0]);
          }
        });

        function handleFiles(file) {
          uploadFile(file);
        }

        function uploadFile(file) {
          const formData = new FormData();
          formData.append("file", file);

          // 언어 설정 추가
          const language = languageSelect.value;
          formData.append("language", language);

          loading.style.display = "block";
          resultContainer.style.display = "none";

          // 프로그레스바 초기화
          progressBarInner.style.width = "0%";
          progressBarInner.setAttribute("aria-valuenow", 0);
          statusText.textContent = "{{ _('준비 중...') }}";
          elapsedTimeText.textContent = "{{ _('경과 시간: 0분 0초') }}";

          if (file.size > 20 * 1024 * 1024) {
            document.querySelector("#loading p").textContent =
              "{{ _('대용량 파일 처리 중입니다. 파일 크기에 따라 몇 분이 소요될 수 있습니다...') }}";
          } else {
            document.querySelector("#loading p").textContent =
              "{{ _('음성을 텍스트로 변환 중입니다. 잠시만 기다려주세요...') }}";
          }

          fetch("/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`{{ _('서버 오류:') }} ${response.status}`);
              }

              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                return response.json();
              } else {
                throw new Error(
                  "{{ _('서버가 JSON이 아닌 응답을 반환했습니다') }}"
                );
              }
            })
            .then((data) => {
              if (data.success) {
                currentTaskId = data.task_id;
                startStatusCheck();
              } else {
                loading.style.display = "none";
                alert("{{ _('오류:') }} " + data.error);
              }
            })
            .catch((error) => {
              loading.style.display = "none";
              alert(
                "{{ _('업로드 중 오류가 발생했습니다:') }} " + error.message
              );
            });
        }

        function startStatusCheck() {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
          }

          statusCheckInterval = setInterval(checkTaskStatus, 500); // 더 빠른 업데이트를 위해 500ms로 변경
        }

        function stopStatusCheck() {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
          }
        }

        function checkTaskStatus() {
          if (!currentTaskId) return;

          fetch(`/status/${currentTaskId}`)
            .then((response) => response.json())
            .then((data) => {
              updateProgressBar(data);

              if (data.completed) {
                stopStatusCheck();

                if (data.success) {
                  loading.style.display = "none";
                  resultContainer.style.display = "block";

                  // 세그먼트 정보 저장
                  if (data.segments) {
                    segments = data.segments;
                  }

                  // 오디오 플레이어 설정
                  if (data.audio_path) {
                    setupAudioPlayer(data.audio_path);
                  }

                  // 변환 결과 표시
                  displayTranscriptionResult(data.transcription);

                  // 페이지 새로고침 (세션 목록 업데이트)
                  setTimeout(() => {
                    window.location.reload();
                  }, 2000);
                } else {
                  loading.style.display = "none";
                  alert("{{ _('오류:') }} " + data.error);
                }
              }
            })
            .catch((error) => {
              console.error("{{ _('상태 확인 중 오류:') }}", error);
            });
        }

        function updateProgressBar(data) {
          const progress = data.progress >= 0 ? data.progress : 0;
          progressBarInner.style.width = `${progress}%`;
          progressBarInner.setAttribute("aria-valuenow", progress);

          statusText.textContent = data.status || "{{ _('처리 중...') }}";

          if (data.elapsed_time !== undefined) {
            const minutes = Math.floor(data.elapsed_time / 60);
            const seconds = data.elapsed_time % 60;
            elapsedTimeText.textContent = `{{ _('경과 시간:') }} ${minutes}{{ _('분') }} ${seconds}{{ _('초') }}`;
          }

          if (progress < 30) {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-info";
          } else if (progress < 70) {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-primary";
          } else {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-success";
          }
        }

        copyBtn.addEventListener("click", function () {
          const text = transcriptionResult.textContent;
          navigator.clipboard.writeText(text).then(() => {
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check"></i> {{ _("복사됨") }}';
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
            }, 2000);
          });
        });

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // 세그먼트 텍스트 업데이트 함수
        function updateSegmentText(segmentId, newText, index) {
          // 현재 세션 ID 가져오기
          const sessionId =
            currentTaskId ||
            document
              .querySelector(".session-card.active")
              ?.getAttribute("data-session-id");

          console.log("업데이트 요청:", {
            sessionId,
            segmentId,
            index,
            newText,
            segments,
          });

          if (!sessionId) {
            showToast("세션 ID를 찾을 수 없습니다.", "danger");
            return;
          }

          // 세그먼트 ID 확인 및 수정
          // 세그먼트 ID가 없거나 유효하지 않은 경우 인덱스를 사용
          const validSegmentId =
            segmentId !== undefined && segmentId !== null && segmentId !== ""
              ? segmentId
              : index;

          console.log("유효한 세그먼트 ID:", validSegmentId);

          // API 요청 데이터
          const data = {
            segment_id: validSegmentId,
            text: newText,
            session_id: sessionId,
          };

          console.log("API 요청 데이터:", JSON.stringify(data));

          // 로딩 표시
          const segmentElement = document.getElementById(`segment-${index}`);
          const saveButton = segmentElement.querySelector(".save-edit-btn");
          const originalButtonText = saveButton.textContent;
          saveButton.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 저장 중...';
          saveButton.disabled = true;

          // API 호출
          fetch("/update_segment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              console.log("응답 상태:", response.status);
              return response.json();
            })
            .then((data) => {
              console.log("업데이트 응답:", data);
              if (data.success) {
                // UI 업데이트
                segmentElement.querySelector(".segment-text").textContent =
                  newText;
                segmentElement.querySelector(".segment-text").style.display =
                  "block";
                segmentElement.querySelector(
                  ".segment-edit-form"
                ).style.display = "none";
                segmentElement.querySelector(
                  ".edit-segment-btn"
                ).style.display = "inline-block";

                // 세그먼트 데이터 업데이트
                segments[index].text = newText;

                // 성공 메시지 표시
                showToast(
                  "세그먼트가 성공적으로 업데이트되었습니다.",
                  "success"
                );
              } else {
                // 오류 메시지 표시
                showToast("세그먼트 업데이트 실패: " + data.error, "danger");
              }
            })
            .catch((error) => {
              console.error("업데이트 오류:", error);
              // 오류 메시지 표시
              showToast(
                "세그먼트 업데이트 중 오류 발생: " + error.message,
                "danger"
              );
            })
            .finally(() => {
              // 로딩 표시 제거
              saveButton.textContent = originalButtonText;
              saveButton.disabled = false;
            });
        }

        // 토스트 메시지 표시 함수
        function showToast(message, type = "info") {
          // 이미 있는 토스트 컨테이너 확인
          let toastContainer = document.querySelector(".toast-container");

          // 없으면 생성
          if (!toastContainer) {
            toastContainer = document.createElement("div");
            toastContainer.className =
              "toast-container position-fixed bottom-0 end-0 p-3";
            document.body.appendChild(toastContainer);
          }

          // 토스트 ID 생성
          const toastId = "toast-" + Date.now();

          // 토스트 HTML 생성
          const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          `;

          // 토스트 추가
          toastContainer.insertAdjacentHTML("beforeend", toastHtml);

          // 토스트 객체 생성 및 표시
          const toastElement = document.getElementById(toastId);
          const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
          toast.show();

          // 자동 제거
          toastElement.addEventListener("hidden.bs.toast", function () {
            this.remove();
          });
        }

        // 시간 업데이트 핸들러 (디바운싱 적용)
        let lastUpdateTime = 0;
        function handleTimeUpdate() {
          const currentTime = this.currentTime;
          const now = Date.now();

          // 디바운싱 시간 증가 (150ms로 변경)
          // 자막이 너무 빨리 이동하는 문제 해결
          if (now - lastUpdateTime > 150) {
            // 오디오 재생 속도에 따른 조정
            const playbackRate = this.playbackRate || 1.0;
            console.log("재생 속도:", playbackRate);

            // 재생 속도가 빠를수록 더 큰 지연 적용
            highlightCurrentSegment(currentTime);
            lastUpdateTime = now;
          }
        }

        // 오디오 플레이어 설정
        function setupAudioPlayer(audioPath) {
          const audioPlayer = document.getElementById("audio-player");
          const audioContainer = document.getElementById(
            "audio-player-container"
          );

          // 오디오 소스 설정
          audioPlayer.querySelector("source").src = `/audio/${audioPath}`;
          audioPlayer.load();

          // 오디오 플레이어 표시
          audioContainer.style.display = "block";

          // 기존 이벤트 리스너 제거 (중복 방지)
          audioPlayer.removeEventListener("timeupdate", handleTimeUpdate);

          // 오디오 시간 업데이트 이벤트 리스너 추가
          audioPlayer.addEventListener("timeupdate", handleTimeUpdate);

          // 재생 속도 변경 이벤트 리스너
          audioPlayer.addEventListener("ratechange", function () {
            console.log("재생 속도 변경됨:", this.playbackRate);
          });

          // 오디오 로드 완료 이벤트
          audioPlayer.addEventListener("loadedmetadata", function () {
            console.log(
              "오디오 로드 완료, 총 길이:",
              audioPlayer.duration.toFixed(2),
              "초"
            );
          });
        }

        // 현재 시간에 해당하는 세그먼트 하이라이트
        function highlightCurrentSegment(currentTime) {
          if (!segments || segments.length === 0) return;

          // 디버깅 정보 출력
          console.log("현재 오디오 시간:", currentTime.toFixed(2));

          // 약간의 지연 시간 추가 (자막이 소리보다 빠른 문제 해결)
          const adjustedTime = Math.max(0, currentTime - 0.3);
          console.log("조정된 시간:", adjustedTime.toFixed(2));

          // 현재 시간에 해당하는 세그먼트 찾기
          let foundIndex = -1;
          let closestSegment = null;
          let minDistance = Infinity;

          // 정확한 범위 내에 있는 세그먼트 찾기
          for (let i = 0; i < segments.length; i++) {
            const segment = segments[i];

            // 조정된 시간으로 세그먼트 검색
            if (adjustedTime >= segment.start && adjustedTime <= segment.end) {
              foundIndex = i;
              break;
            }

            // 가장 가까운 세그먼트 찾기 (정확한 범위 내에 없는 경우를 대비)
            const startDistance = Math.abs(adjustedTime - segment.start);
            const endDistance = Math.abs(adjustedTime - segment.end);
            const distance = Math.min(startDistance, endDistance);

            if (distance < minDistance) {
              minDistance = distance;
              closestSegment = i;
            }
          }

          // 정확한 범위 내에 세그먼트가 없으면 가장 가까운 세그먼트 사용
          // 거리 임계값을 늘려 더 관대하게 세그먼트 선택
          if (
            foundIndex === -1 &&
            closestSegment !== null &&
            minDistance < 2.5
          ) {
            foundIndex = closestSegment;
            console.log(
              "가장 가까운 세그먼트 선택:",
              foundIndex,
              "거리:",
              minDistance.toFixed(2)
            );
          }

          // 이전 세그먼트와 다른 경우에만 업데이트
          if (foundIndex !== activeSegmentIndex) {
            console.log("세그먼트 변경:", activeSegmentIndex, "->", foundIndex);

            // 이전 활성 세그먼트 비활성화
            if (activeSegmentIndex >= 0) {
              const prevSegmentElement = document.getElementById(
                `segment-${activeSegmentIndex}`
              );
              if (prevSegmentElement) {
                prevSegmentElement.classList.remove("active");
              }
            }

            // 새 세그먼트 활성화
            if (foundIndex >= 0) {
              const newSegmentElement = document.getElementById(
                `segment-${foundIndex}`
              );
              if (newSegmentElement) {
                newSegmentElement.classList.add("active");

                // 해당 세그먼트로 스크롤 (부드러운 스크롤 사용)
                newSegmentElement.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
            }

            // 활성 세그먼트 인덱스 업데이트
            activeSegmentIndex = foundIndex;
          }
        }

        // 변환 결과 표시
        function displayTranscriptionResult(transcription) {
          // 세그먼트 기반 결과 표시
          if (segments && segments.length > 0) {
            let html = "";

            console.log("세그먼트 데이터:", segments);

            segments.forEach((segment, index) => {
              const text = segment.text;
              const start = segment.start.toFixed(1);
              const end = segment.end.toFixed(1);

              // 세그먼트 ID 처리 (문자열로 변환)
              // 세그먼트 ID가 없는 경우 인덱스를 사용
              const segmentId =
                segment.id !== undefined ? String(segment.id) : String(index);

              console.log(
                `세그먼트 ${index}: ID=${segmentId}, 원본ID=${
                  segment.id
                }, 타입=${typeof segment.id}`
              );

              // 세그먼트 HTML 생성 (수정 버튼 추가)
              html += `<div id="segment-${index}" class="segment" data-start="${start}" data-end="${end}" data-segment-id="${segmentId}">`;
              html += `<div class="d-flex justify-content-between align-items-start">`;
              html += `<span class="time">[${start}s - ${end}s]</span>`;
              html += `<button class="btn btn-sm btn-outline-secondary edit-segment-btn" data-index="${index}"><i class="bi bi-pencil"></i></button>`;
              html += `</div>`;
              html += `<div class="segment-text">${escapeHtml(text)}</div>`;
              html += `<div class="segment-edit-form" style="display: none;">`;
              html += `<textarea class="form-control segment-edit-textarea mb-2">${escapeHtml(
                text
              )}</textarea>`;
              html += `<div class="d-flex justify-content-end">`;
              html += `<button class="btn btn-sm btn-secondary me-2 cancel-edit-btn">취소</button>`;
              html += `<button class="btn btn-sm btn-primary save-edit-btn">저장</button>`;
              html += `</div>`;
              html += `</div>`;
              html += `</div>`;
            });

            transcriptionResult.innerHTML = html;

            // 세그먼트 클릭 이벤트 추가
            document.querySelectorAll(".segment").forEach((element) => {
              element.addEventListener("click", function (e) {
                // 편집 버튼이나 편집 폼 요소를 클릭한 경우 오디오 이동 방지
                if (
                  e.target.closest(".edit-segment-btn") ||
                  e.target.closest(".segment-edit-form")
                ) {
                  return;
                }

                const start = parseFloat(this.getAttribute("data-start"));
                const audioPlayer = document.getElementById("audio-player");

                // 오디오 플레이어 시간 이동
                audioPlayer.currentTime = start;

                // 세그먼트 활성화 (즉시 시각적 피드백 제공)
                const index = parseInt(this.id.replace("segment-", ""));

                // 이전 활성 세그먼트 비활성화
                if (activeSegmentIndex >= 0 && activeSegmentIndex !== index) {
                  const prevSegmentElement = document.getElementById(
                    `segment-${activeSegmentIndex}`
                  );
                  if (prevSegmentElement) {
                    prevSegmentElement.classList.remove("active");
                  }
                }

                // 새 세그먼트 활성화
                this.classList.add("active");
                activeSegmentIndex = index;

                // 세그먼트 정보 출력
                console.log(
                  "세그먼트 클릭:",
                  index,
                  "시작 시간:",
                  start,
                  "텍스트:",
                  segments[index].text
                );

                // 재생 중이 아니면 재생 시작
                if (audioPlayer.paused) {
                  audioPlayer
                    .play()
                    .then(() => {
                      console.log("재생 시작됨");
                    })
                    .catch((err) => {
                      console.error("재생 시작 오류:", err);
                    });
                }
              });
            });

            // 수정 버튼 클릭 이벤트
            document.querySelectorAll(".edit-segment-btn").forEach((button) => {
              button.addEventListener("click", function (e) {
                e.stopPropagation();
                const index = this.getAttribute("data-index");
                const segmentElement = document.getElementById(
                  `segment-${index}`
                );

                // 텍스트 영역 숨기고 편집 폼 표시
                segmentElement.querySelector(".segment-text").style.display =
                  "none";
                segmentElement.querySelector(
                  ".segment-edit-form"
                ).style.display = "block";

                // 편집 버튼 숨기기
                this.style.display = "none";

                // 텍스트 영역에 포커스
                segmentElement.querySelector(".segment-edit-textarea").focus();
              });
            });

            // 취소 버튼 클릭 이벤트
            document.querySelectorAll(".cancel-edit-btn").forEach((button) => {
              button.addEventListener("click", function (e) {
                e.stopPropagation();
                const segmentElement = this.closest(".segment");

                // 편집 폼 숨기고 텍스트 영역 표시
                segmentElement.querySelector(
                  ".segment-edit-form"
                ).style.display = "none";
                segmentElement.querySelector(".segment-text").style.display =
                  "block";

                // 편집 버튼 다시 표시
                segmentElement.querySelector(
                  ".edit-segment-btn"
                ).style.display = "inline-block";
              });
            });

            // 저장 버튼 클릭 이벤트
            document.querySelectorAll(".save-edit-btn").forEach((button) => {
              button.addEventListener("click", function (e) {
                e.stopPropagation();
                const segmentElement = this.closest(".segment");
                const segmentId =
                  segmentElement.getAttribute("data-segment-id");
                const newText = segmentElement.querySelector(
                  ".segment-edit-textarea"
                ).value;
                const index = parseInt(
                  segmentElement.id.replace("segment-", "")
                );

                // 세그먼트 업데이트 API 호출
                updateSegmentText(segmentId, newText, index);
              });
            });
          } else {
            // 기존 방식으로 결과 표시 (세그먼트 정보가 없는 경우)
            transcriptionResult.innerHTML = escapeHtml(transcription);
          }
        }

        // 세션 삭제 버튼 클릭 이벤트 처리
        document.querySelectorAll(".delete-session-btn").forEach((button) => {
          button.addEventListener("click", function (e) {
            e.stopPropagation(); // 세션 카드 클릭 이벤트 방지

            // 세션 정보 가져오기
            const sessionId = this.getAttribute("data-session-id");
            const sessionName = this.getAttribute("data-session-name");

            // 모달에 세션 정보 표시
            document.getElementById("delete-session-name").textContent =
              sessionName;

            // 삭제할 세션 ID 저장
            deleteSessionId = sessionId;

            // 모달 표시
            const deleteModal = new bootstrap.Modal(
              document.getElementById("deleteSessionModal")
            );
            deleteModal.show();
          });
        });

        // 세션 삭제 확인 버튼 클릭 이벤트
        document
          .getElementById("confirm-delete-btn")
          .addEventListener("click", function () {
            if (!deleteSessionId) return;

            // 삭제 API 호출
            deleteSession(deleteSessionId);

            // 모달 닫기
            const deleteModal = bootstrap.Modal.getInstance(
              document.getElementById("deleteSessionModal")
            );
            deleteModal.hide();
          });

        // 세션 삭제 함수
        function deleteSession(sessionId) {
          // 로딩 표시
          const deleteBtn = document.querySelector(
            `.delete-session-btn[data-session-id="${sessionId}"]`
          );
          const originalBtnHtml = deleteBtn.innerHTML;
          deleteBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 삭제 중...';
          deleteBtn.disabled = true;

          // 삭제 API 호출
          fetch(`/delete_session/${sessionId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // 성공 메시지 표시
                showToast("세션이 성공적으로 삭제되었습니다.", "success");

                // 세션 카드 제거
                const sessionCard = document.querySelector(
                  `.session-card[data-session-id="${sessionId}"]`
                );
                if (sessionCard) {
                  const parentCol = sessionCard.closest(".col-md-6");
                  if (parentCol) {
                    parentCol.remove();
                  }
                }

                // 세션 목록이 비어있는지 확인
                const sessionCards = document.querySelectorAll(".session-card");
                if (sessionCards.length === 0) {
                  // 세션이 없는 경우 메시지 표시
                  const sessionList = document.querySelector(".session-list");
                  sessionList.innerHTML = `
                    <div class="alert alert-info">
                      {{ _('아직 변환 기록이 없습니다. 새 파일을 변환해보세요.') }}
                    </div>
                  `;
                }

                // 현재 표시 중인 세션이 삭제된 경우 결과 컨테이너 숨기기
                if (currentTaskId === sessionId) {
                  resultContainer.style.display = "none";
                  currentTaskId = null;
                }
              } else {
                // 오류 메시지 표시
                showToast(
                  "세션 삭제 실패: " + (data.error || "알 수 없는 오류"),
                  "danger"
                );

                // 버튼 복원
                deleteBtn.innerHTML = originalBtnHtml;
                deleteBtn.disabled = false;
              }
            })
            .catch((error) => {
              // 오류 메시지 표시
              showToast("세션 삭제 중 오류 발생: " + error.message, "danger");

              // 버튼 복원
              deleteBtn.innerHTML = originalBtnHtml;
              deleteBtn.disabled = false;
            });
        }
      });
    </script>
  </body>
</html>

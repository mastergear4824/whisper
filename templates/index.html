<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whisper 음성-텍스트 변환기</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        padding-top: 2rem;
        background-color: #f8f9fa;
      }
      .container {
        max-width: 800px;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover {
        border-color: #0d6efd;
        background-color: #f1f8ff;
      }
      .upload-area.highlight {
        border-color: #0d6efd;
        background-color: #e6f2ff;
      }
      #result-container {
        display: none;
        margin-top: 2rem;
      }
      #loading {
        display: none;
        text-align: center;
        margin-top: 1rem;
      }
      .copy-btn {
        cursor: pointer;
      }
      #transcription-result {
        white-space: pre-wrap; /* 행 바꿈 유지 */
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        max-height: 500px;
        overflow-y: auto;
      }

      /* 오디오 플레이어 스타일 */
      .audio-player-container {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .audio-player {
        width: 100%;
      }

      /* 세그먼트 스타일 */
      .segment {
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        transition: background-color 0.3s;
        border: 1px solid #f0f0f0;
      }

      .segment.active {
        background-color: #fff8e1;
        box-shadow: 0 0 0 2px #ffd54f;
      }

      .segment-text {
        margin-top: 0.5rem;
      }

      .time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-left: 0.5rem;
        font-family: monospace;
      }

      /* 언어 선택 스타일 */
      .language-select {
        margin-bottom: 1rem;
      }

      /* 프로그레스바 스타일 */
      .progress {
        height: 20px;
        margin-top: 15px;
        margin-bottom: 10px;
      }

      /* 세션 목록 스타일 */
      .session-list {
        margin-top: 2rem;
      }

      .session-card {
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
      }

      .session-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      .session-card .card-body {
        padding: 1rem;
      }

      .session-card .card-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .session-card .card-text {
        font-size: 0.85rem;
        color: #6c757d;
      }

      .session-card .language-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }

      .tab-content {
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Whisper 음성-텍스트 변환기</h1>

      <!-- 탭 메뉴 -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="new-tab"
            data-bs-toggle="tab"
            data-bs-target="#new-content"
            type="button"
            role="tab"
            aria-controls="new-content"
            aria-selected="true"
          >
            <i class="bi bi-plus-circle"></i> 새 변환
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="history-tab"
            data-bs-toggle="tab"
            data-bs-target="#history-content"
            type="button"
            role="tab"
            aria-controls="history-content"
            aria-selected="false"
          >
            <i class="bi bi-clock-history"></i> 이전 기록
          </button>
        </li>
      </ul>

      <!-- 탭 내용 -->
      <div class="tab-content" id="myTabContent">
        <!-- 새 변환 탭 -->
        <div
          class="tab-pane fade show active"
          id="new-content"
          role="tabpanel"
          aria-labelledby="new-tab"
        >
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">음성 파일 업로드</h5>
              <p class="card-text">
                MP3, WAV, OGG, M4A, FLAC 형식의 오디오 파일을 업로드하세요.
              </p>
              <p class="text-info">
                <i class="bi bi-info-circle"></i> 선택한 언어로 음성을 텍스트로
                변환합니다. 문장 사이에 자동으로 행 바꿈이 추가됩니다.
              </p>

              <div class="language-select">
                <label for="language-select" class="form-label"
                  >언어 선택:</label
                >
                <select class="form-select" id="language-select">
                  {% for code, name in languages.items() %}
                  <option value="{{ code }}">{{ name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div id="upload-area" class="upload-area">
                <div id="upload-prompt">
                  <i class="bi bi-cloud-arrow-up fs-1"></i>
                  <p>파일을 여기에 끌어다 놓거나 클릭하여 선택하세요</p>
                  <button id="select-file-btn" class="btn btn-primary">
                    파일 선택
                  </button>
                </div>
                <input
                  type="file"
                  id="file-input"
                  accept=".mp3,.wav,.ogg,.m4a,.flac"
                  style="display: none"
                />
              </div>

              <div id="loading" class="mt-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">로딩 중...</span>
                </div>
                <p class="mt-2">
                  음성을 텍스트로 변환 중입니다. 잠시만 기다려주세요...
                </p>
                <div class="progress">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
                <p class="status-text mt-2"></p>
                <p
                  class="elapsed-time mt-1"
                  style="font-size: 0.9em; color: #6c757d"
                ></p>
              </div>
            </div>
          </div>
        </div>

        <!-- 이전 기록 탭 -->
        <div
          class="tab-pane fade"
          id="history-content"
          role="tabpanel"
          aria-labelledby="history-tab"
        >
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">이전 변환 기록</h5>
              <p class="card-text">
                이전에 변환한 파일 목록입니다. 클릭하여 결과를 확인할 수
                있습니다.
              </p>

              <div class="session-list">
                {% if sessions %}
                <div class="row">
                  {% for session in sessions %}
                  <div class="col-md-6">
                    <div
                      class="card session-card"
                      data-session-id="{{ session.id }}"
                    >
                      <div class="card-body">
                        <h5 class="card-title">{{ session.filename }}</h5>
                        <p class="card-text">
                          <small>{{ session.created_at }}</small>
                          <span class="badge bg-info language-badge float-end"
                            >{{ languages[session.language] }}</span
                          >
                        </p>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                  아직 변환 기록이 없습니다. 새 파일을 변환해보세요.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="result-container" class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">변환 결과</h5>
            <button id="copy-btn" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-clipboard"></i> 복사
            </button>
          </div>

          <!-- 오디오 플레이어 추가 -->
          <div
            id="audio-player-container"
            class="audio-player-container"
            style="display: none"
          >
            <audio id="audio-player" class="audio-player" controls>
              <source src="" type="audio/mpeg" />
              브라우저가 오디오 재생을 지원하지 않습니다.
            </audio>
          </div>

          <div id="transcription-result" class="p-3 bg-light rounded"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const uploadArea = document.getElementById("upload-area");
        const fileInput = document.getElementById("file-input");
        const selectFileBtn = document.getElementById("select-file-btn");
        const loading = document.getElementById("loading");
        const resultContainer = document.getElementById("result-container");
        const transcriptionResult = document.getElementById(
          "transcription-result"
        );
        const copyBtn = document.getElementById("copy-btn");
        const languageSelect = document.getElementById("language-select");

        const progressBar = loading.querySelector(".progress");
        const progressBarInner = progressBar.querySelector(".progress-bar");
        const statusText = loading.querySelector(".status-text");
        const elapsedTimeText = loading.querySelector(".elapsed-time");

        let currentTaskId = null;
        let statusCheckInterval = null;
        let segments = []; // 세그먼트 정보 저장
        let activeSegmentIndex = -1; // 현재 활성화된 세그먼트 인덱스

        // 세션 카드 클릭 이벤트 처리
        document.querySelectorAll(".session-card").forEach((card) => {
          card.addEventListener("click", function () {
            const sessionId = this.getAttribute("data-session-id");
            loadSession(sessionId);
          });
        });

        // 세션 로드 함수
        function loadSession(sessionId) {
          // 로딩 표시
          loading.style.display = "block";
          resultContainer.style.display = "none";

          // 세션 정보 가져오기
          fetch(`/status/${sessionId}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // 세션 데이터 표시
                loading.style.display = "none";
                resultContainer.style.display = "block";

                // 세그먼트 정보 저장
                if (data.segments) {
                  segments = data.segments;
                }

                // 오디오 플레이어 설정
                if (data.audio_path) {
                  setupAudioPlayer(data.audio_path);
                }

                // 변환 결과 표시
                displayTranscriptionResult(data.transcription);

                // 탭 전환
                const newTabEl = document.querySelector("#new-tab");
                const tab = new bootstrap.Tab(newTabEl);
                tab.show();
              } else {
                loading.style.display = "none";
                alert("오류: " + (data.error || "세션을 불러올 수 없습니다."));
              }
            })
            .catch((error) => {
              loading.style.display = "none";
              alert("세션 로드 중 오류가 발생했습니다: " + error.message);
            });
        }

        selectFileBtn.addEventListener("click", function (e) {
          e.preventDefault();
          fileInput.click();
        });

        uploadArea.addEventListener("click", function (e) {
          if (
            e.target === uploadArea ||
            e.target.parentElement === uploadArea
          ) {
            fileInput.click();
          }
        });

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          uploadArea.classList.add("highlight");
        }

        function unhighlight() {
          uploadArea.classList.remove("highlight");
        }

        uploadArea.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length) {
            handleFiles(files[0]);
          }
        }

        fileInput.addEventListener("change", function () {
          if (this.files.length) {
            handleFiles(this.files[0]);
          }
        });

        function handleFiles(file) {
          uploadFile(file);
        }

        function uploadFile(file) {
          const formData = new FormData();
          formData.append("file", file);

          // 언어 설정 추가
          const language = languageSelect.value;
          formData.append("language", language);

          loading.style.display = "block";
          resultContainer.style.display = "none";

          // 프로그레스바 초기화
          progressBarInner.style.width = "0%";
          progressBarInner.setAttribute("aria-valuenow", 0);
          statusText.textContent = "준비 중...";
          elapsedTimeText.textContent = "경과 시간: 0분 0초";

          if (file.size > 20 * 1024 * 1024) {
            document.querySelector("#loading p").textContent =
              "대용량 파일 처리 중입니다. 파일 크기에 따라 몇 분이 소요될 수 있습니다...";
          } else {
            document.querySelector("#loading p").textContent =
              "음성을 텍스트로 변환 중입니다. 잠시만 기다려주세요...";
          }

          fetch("/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`서버 오류: ${response.status}`);
              }

              const contentType = response.headers.get("content-type");
              if (contentType && contentType.includes("application/json")) {
                return response.json();
              } else {
                throw new Error("서버가 JSON이 아닌 응답을 반환했습니다");
              }
            })
            .then((data) => {
              if (data.success) {
                currentTaskId = data.task_id;
                startStatusCheck();
              } else {
                loading.style.display = "none";
                alert("오류: " + data.error);
              }
            })
            .catch((error) => {
              loading.style.display = "none";
              alert("업로드 중 오류가 발생했습니다: " + error.message);
            });
        }

        function startStatusCheck() {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
          }

          statusCheckInterval = setInterval(checkTaskStatus, 500); // 더 빠른 업데이트를 위해 500ms로 변경
        }

        function stopStatusCheck() {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
          }
        }

        function checkTaskStatus() {
          if (!currentTaskId) return;

          fetch(`/status/${currentTaskId}`)
            .then((response) => response.json())
            .then((data) => {
              updateProgressBar(data);

              if (data.completed) {
                stopStatusCheck();

                if (data.success) {
                  loading.style.display = "none";
                  resultContainer.style.display = "block";

                  // 세그먼트 정보 저장
                  if (data.segments) {
                    segments = data.segments;
                  }

                  // 오디오 플레이어 설정
                  if (data.audio_path) {
                    setupAudioPlayer(data.audio_path);
                  }

                  // 변환 결과 표시
                  displayTranscriptionResult(data.transcription);

                  // 페이지 새로고침 (세션 목록 업데이트)
                  setTimeout(() => {
                    window.location.reload();
                  }, 2000);
                } else {
                  loading.style.display = "none";
                  alert("오류: " + data.error);
                }
              }
            })
            .catch((error) => {
              console.error("상태 확인 중 오류:", error);
            });
        }

        function updateProgressBar(data) {
          const progress = data.progress >= 0 ? data.progress : 0;
          progressBarInner.style.width = `${progress}%`;
          progressBarInner.setAttribute("aria-valuenow", progress);

          statusText.textContent = data.status || "처리 중...";

          if (data.elapsed_time !== undefined) {
            const minutes = Math.floor(data.elapsed_time / 60);
            const seconds = data.elapsed_time % 60;
            elapsedTimeText.textContent = `경과 시간: ${minutes}분 ${seconds}초`;
          }

          if (progress < 30) {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-info";
          } else if (progress < 70) {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-primary";
          } else {
            progressBarInner.className =
              "progress-bar progress-bar-striped progress-bar-animated bg-success";
          }
        }

        copyBtn.addEventListener("click", function () {
          const text = transcriptionResult.textContent;
          navigator.clipboard.writeText(text).then(() => {
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="bi bi-check"></i> 복사됨';
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
            }, 2000);
          });
        });

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        // 오디오 플레이어 설정
        function setupAudioPlayer(audioPath) {
          const audioPlayer = document.getElementById("audio-player");
          const audioContainer = document.getElementById(
            "audio-player-container"
          );

          // 오디오 소스 설정
          audioPlayer.querySelector("source").src = `/audio/${audioPath}`;
          audioPlayer.load();

          // 오디오 플레이어 표시
          audioContainer.style.display = "block";

          // 오디오 시간 업데이트 이벤트 리스너
          audioPlayer.addEventListener("timeupdate", function () {
            const currentTime = audioPlayer.currentTime;
            highlightCurrentSegment(currentTime);
          });
        }

        // 현재 시간에 해당하는 세그먼트 하이라이트
        function highlightCurrentSegment(currentTime) {
          if (!segments || segments.length === 0) return;

          // 현재 시간에 해당하는 세그먼트 찾기
          let foundIndex = -1;

          for (let i = 0; i < segments.length; i++) {
            const segment = segments[i];
            if (currentTime >= segment.start && currentTime <= segment.end) {
              foundIndex = i;
              break;
            }
          }

          // 이전 세그먼트와 다른 경우에만 업데이트
          if (foundIndex !== activeSegmentIndex) {
            // 이전 활성 세그먼트 비활성화
            if (activeSegmentIndex >= 0) {
              const prevSegmentElement = document.getElementById(
                `segment-${activeSegmentIndex}`
              );
              if (prevSegmentElement) {
                prevSegmentElement.classList.remove("active");
              }
            }

            // 새 세그먼트 활성화
            if (foundIndex >= 0) {
              const newSegmentElement = document.getElementById(
                `segment-${foundIndex}`
              );
              if (newSegmentElement) {
                newSegmentElement.classList.add("active");

                // 해당 세그먼트로 스크롤
                newSegmentElement.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
            }

            // 활성 세그먼트 인덱스 업데이트
            activeSegmentIndex = foundIndex;
          }
        }

        // 변환 결과 표시
        function displayTranscriptionResult(transcription) {
          // 세그먼트 기반 결과 표시
          if (segments && segments.length > 0) {
            let html = "";

            segments.forEach((segment, index) => {
              const text = segment.text;
              const start = segment.start.toFixed(1);
              const end = segment.end.toFixed(1);

              // 세그먼트 HTML 생성
              html += `<div id="segment-${index}" class="segment" data-start="${start}" data-end="${end}">`;
              html += `<span class="time">[${start}s - ${end}s]</span>`;
              html += `<div class="segment-text">${escapeHtml(text)}</div>`;
              html += `</div>`;
            });

            transcriptionResult.innerHTML = html;

            // 세그먼트 클릭 이벤트 추가
            document.querySelectorAll(".segment").forEach((element) => {
              element.addEventListener("click", function () {
                const start = parseFloat(this.getAttribute("data-start"));
                const audioPlayer = document.getElementById("audio-player");

                // 오디오 플레이어 시간 이동
                audioPlayer.currentTime = start;

                // 재생 중이 아니면 재생 시작
                if (audioPlayer.paused) {
                  audioPlayer.play();
                }
              });
            });
          } else {
            // 기존 방식으로 결과 표시 (세그먼트 정보가 없는 경우)
            transcriptionResult.innerHTML = escapeHtml(transcription);
          }
        }
      });
    </script>
  </body>
</html>
